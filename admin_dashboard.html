<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNS Enterprise API - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #1e293b;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #1e293b;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #334155;
            color: #e2e8f0;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #f1f5f9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #f1f5f9;
        }
        
        .stat-sub {
            font-size: 13px;
            color: #64748b;
            margin-top: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #0f172a;
        }
        
        th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #334155;
        }
        
        tr:hover {
            background: #334155;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-free { background: #3b82f6; color: white; }
        .badge-pro { background: #8b5cf6; color: white; }
        .badge-enterprise { background: #f59e0b; color: white; }
        .badge-active { background: #10b981; color: white; }
        .badge-inactive { background: #ef4444; color: white; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #10b981;
            color: white;
        }
        
        .alert-error {
            background: #ef4444;
            color: white;
        }
        
        .alert-info {
            background: #3b82f6;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .api-key-display {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† CNS Enterprise API - Admin Dashboard</h1>
            <p class="subtitle">Manage API keys, monitor usage, and view system health</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab" onclick="switchTab('keys')">üîë API Keys</button>
            <button class="tab" onclick="switchTab('metrics')">üìà Metrics</button>
            <button class="tab" onclick="switchTab('billing')">üí≥ Billing</button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total API Keys</div>
                    <div class="stat-value" id="total-keys">0</div>
                    <div class="stat-sub">Active accounts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Requests (24h)</div>
                    <div class="stat-value" id="total-requests">0</div>
                    <div class="stat-sub">Last 24 hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-value" id="success-rate">0%</div>
                    <div class="stat-sub">System reliability</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Latency</div>
                    <div class="stat-value" id="avg-latency">0ms</div>
                    <div class="stat-sub">Response time</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Recent Activity</h2>
                <table id="recent-activity">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Last Used</th>
                            <th>Requests (24h)</th>
                            <th>Tier</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- API Keys Tab -->
        <div id="keys" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>API Keys Management</h2>
                    <button class="btn btn-primary" onclick="showCreateKeyModal()">‚ûï Create New Key</button>
                </div>
                
                <table id="keys-table">
                    <thead>
                        <tr>
                            <th>Client Name</th>
                            <th>Email</th>
                            <th>Tier</th>
                            <th>Created</th>
                            <th>Last Used</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Metrics Tab -->
        <div id="metrics" class="tab-content">
            <div class="card">
                <h2>System Performance Metrics</h2>
                <div id="metrics-content" class="loading">
                    <div class="spinner"></div>
                    <p>Loading metrics...</p>
                </div>
            </div>
        </div>
        
        <!-- Billing Tab -->
        <div id="billing" class="tab-content">
            <div class="card">
                <h2>Billing Overview</h2>
                <div id="billing-content" class="loading">
                    <div class="spinner"></div>
                    <p>Loading billing information...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Key Modal -->
    <div id="create-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New API Key</h2>
                <button class="close-btn" onclick="closeCreateKeyModal()">&times;</button>
            </div>
            
            <div id="modal-alert"></div>
            
            <form id="create-key-form">
                <div class="form-group">
                    <label for="client-name">Client Name *</label>
                    <input type="text" id="client-name" required placeholder="Acme Corporation">
                </div>
                
                <div class="form-group">
                    <label for="client-email">Client Email *</label>
                    <input type="email" id="client-email" required placeholder="billing@acme.com">
                </div>
                
                <div class="form-group">
                    <label for="tier">Tier *</label>
                    <select id="tier" required>
                        <option value="free">Free (1K/hour, 10K/day)</option>
                        <option value="pro">Pro (10K/hour, 100K/day) - $99/month</option>
                        <option value="enterprise">Enterprise (Unlimited) - $999/month</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="3" placeholder="Optional notes about this API key"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">Create API Key</button>
            </form>
        </div>
    </div>
    
    <script>
        const ADMIN_API_KEY = prompt('Enter Admin API Key:') || 'test_admin_key_secure_random_12345678abcdef';
        const API_BASE = 'http://localhost:8000';
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Load data for the tab
            if (tabName === 'overview') loadOverview();
            if (tabName === 'keys') loadKeys();
            if (tabName === 'metrics') loadMetrics();
            if (tabName === 'billing') loadBilling();
        }
        
        // Load overview data
        async function loadOverview() {
            try {
                const metricsRes = await fetch(`${API_BASE}/admin/monitoring/metrics?hours=24`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_API_KEY}` }
                });
                const metrics = await metricsRes.json();
                
                const keysRes = await fetch(`${API_BASE}/admin/keys`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_API_KEY}` }
                });
                const keysData = await keysRes.json();
                
                document.getElementById('total-keys').textContent = keysData.total || 0;
                document.getElementById('total-requests').textContent = (metrics.metrics?.total_requests || 0).toLocaleString();
                document.getElementById('success-rate').textContent = Math.round(metrics.metrics?.success_rate || 0) + '%';
                document.getElementById('avg-latency').textContent = Math.round(metrics.metrics?.latency?.avg_ms || 0) + 'ms';
                
                // Recent activity
                const tbody = document.querySelector('#recent-activity tbody');
                tbody.innerHTML = keysData.keys?.slice(0, 5).map(key => `
                    <tr>
                        <td>${key.client_name}</td>
                        <td>${key.last_used}</td>
                        <td>-</td>
                        <td><span class="badge badge-${key.tier}">${key.tier}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="4">No keys found</td></tr>';
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }
        
        // Load API keys
        async function loadKeys() {
            try {
                const res = await fetch(`${API_BASE}/admin/keys`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_API_KEY}` }
                });
                const data = await res.json();
                
                const tbody = document.querySelector('#keys-table tbody');
                tbody.innerHTML = data.keys?.map(key => `
                    <tr>
                        <td>${key.client_name}</td>
                        <td>${key.client_email}</td>
                        <td><span class="badge badge-${key.tier}">${key.tier}</span></td>
                        <td>${new Date(key.created_at).toLocaleDateString()}</td>
                        <td>${key.last_used}</td>
                        <td><span class="badge badge-${key.is_active ? 'active' : 'inactive'}">${key.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            ${key.is_active ? `<button class="btn btn-danger btn-sm" onclick="revokeKey('${key.key_id}', '${key.client_name}')">Revoke</button>` : 'Revoked'}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="7">No keys found</td></tr>';
            } catch (error) {
                console.error('Error loading keys:', error);
            }
        }
        
        // Load metrics
        async function loadMetrics() {
            try {
                const res = await fetch(`${API_BASE}/admin/monitoring/metrics?hours=24`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_API_KEY}` }
                });
                const data = await res.json();
                
                document.getElementById('metrics-content').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Requests</div>
                            <div class="stat-value">${(data.metrics?.total_requests || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Successful</div>
                            <div class="stat-value">${(data.metrics?.successful_requests || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Failed</div>
                            <div class="stat-value">${(data.metrics?.failed_requests || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Clients</div>
                            <div class="stat-value">${data.metrics?.throughput?.active_clients || 0}</div>
                        </div>
                    </div>
                    
                    <h3 style="margin: 30px 0 15px;">Latency Distribution</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Average</div>
                            <div class="stat-value">${Math.round(data.metrics?.latency?.avg_ms || 0)}ms</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">P95</div>
                            <div class="stat-value">${Math.round(data.metrics?.latency?.p95_ms || 0)}ms</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">P99</div>
                            <div class="stat-value">${Math.round(data.metrics?.latency?.p99_ms || 0)}ms</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading metrics:', error);
                document.getElementById('metrics-content').innerHTML = '<p>Error loading metrics</p>';
            }
        }
        
        // Load billing
        async function loadBilling() {
            try {
                const res = await fetch(`${API_BASE}/admin/billing/overview`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_API_KEY}` }
                });
                const data = await res.json();
                
                document.getElementById('billing-content').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Customers</div>
                            <div class="stat-value">${data.total_customers || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Subscriptions</div>
                            <div class="stat-value">${data.active_subscriptions || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Invoices</div>
                            <div class="stat-value">${data.total_invoices || 0}</div>
                        </div>
                    </div>
                    
                    ${data.total_customers > 0 ? `
                        <h3 style="margin: 30px 0 15px;">Recent Customers</h3>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto;">${JSON.stringify(data.customers?.slice(0, 3), null, 2)}</pre>
                    ` : '<p style="text-align: center; color: #64748b; margin-top: 30px;">No billing data available. Stripe integration required.</p>'}
                `;
            } catch (error) {
                console.error('Error loading billing:', error);
                document.getElementById('billing-content').innerHTML = '<p>Billing not enabled (requires STRIPE_SECRET_KEY)</p>';
            }
        }
        
        // Create key modal
        function showCreateKeyModal() {
            document.getElementById('create-key-modal').classList.add('active');
        }
        
        function closeCreateKeyModal() {
            document.getElementById('create-key-modal').classList.remove('active');
            document.getElementById('create-key-form').reset();
            document.getElementById('modal-alert').innerHTML = '';
        }
        
        // Handle form submission
        document.getElementById('create-key-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                client_name: document.getElementById('client-name').value,
                client_email: document.getElementById('client-email').value,
                tier: document.getElementById('tier').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const res = await fetch(`${API_BASE}/admin/keys/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ADMIN_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                
                if (res.ok) {
                    document.getElementById('modal-alert').innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ API Key Created Successfully!</strong>
                            <div class="api-key-display">${result.api_key}</div>
                            <p style="margin-top: 10px;">‚ö†Ô∏è Save this key now - it will not be shown again!</p>
                        </div>
                    `;
                    document.getElementById('create-key-form').reset();
                    loadKeys(); // Refresh keys table
                } else {
                    throw new Error(result.message || 'Failed to create key');
                }
            } catch (error) {
                document.getElementById('modal-alert').innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        });
        
        // Revoke key
        async function revokeKey(keyId, clientName) {
            if (!confirm(`Are you sure you want to revoke the API key for ${clientName}?`)) {
                return;
            }
            
            const reason = prompt('Reason for revocation:') || 'No reason provided';
            
            try {
                const res = await fetch(`${API_BASE}/admin/keys/${keyId}/revoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ADMIN_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (res.ok) {
                    alert('‚úÖ API key revoked successfully');
                    loadKeys(); // Refresh table
                } else {
                    throw new Error('Failed to revoke key');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Initial load
        loadOverview();
    </script>
</body>
</html>
